<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Prospect</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/redmond/jquery-ui.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="/style/default.css">

    <script src="script/B/B2_0-Core.js"></script>
    <script src="script/B/B2_0-Dialog.js"></script>
    <script src="script/B/B2_0-Data.js"></script>
    <script src="script/B/B2_0-Table.js"></script>
    <script src="script/B/B2_0-Menu.js"></script>

    <script>
    var page = { pid:B.queryString("PID"), qid:B.queryString("ID") }
    function init() {
        var frm = new B.Form("frmQuote");
        frm.set("pid", page.pid);
        frm.set("qid", page.qid);
        if (page.qid != "NEW") {
            frm.set("lob","PPO1 - Blue Options");
            var tab = top.itabs.getTab(window);
        }
    }

    function saveQuote() {
        var prosp = top.app.data.prospects[page.pid];
        if (prosp == null) {
            sayError("Could not find prospect #" + page.pid);
        } else {
            if (page.qid == "NEW") { // Adding a new quote
                var newid = 123000 + new Date().getMilliseconds();
                while (prosp.quotes[newid] != null) {
                    newid = 123000 + new Date().getMilliseconds();
                }
                prosp.quotes.push({ id:newid, effdat:new Date("2/1/2019"), lob:'PPO1', ts:new Date() });
                top.B.growl.msg("Quote saved", "Quote #" + newid + " for prospect #" + prosp.pid + " was saved successfully.");
                var tab = top.itabs.tabs["prosp|" + page.pid];
                if (tab != null) {
                    top.app.goBackTab = tab.id;
                    tab.window.loadQuotes();
                }
                top.itabs.closeTab(top.itabs.getTab(window).id);
            } else {
                var quote = null;
                for (var i = 0; i < prosp.quotes.length; i++) {
                    var possible = prosp.quotes[i];
                    if (possible.id == page.qid) {
                        quote = possible;
                        break;
                    }
                }
                if (quote == null) { // Could not find the quote??
                    sayError("Could not find quote #" + page.qid);
                } else {
                    sayWarn("I don't think you will ever be able to save an existing quote.");
                }

            }
        }
    }
    function saveNewQuote() {
        var thistab = top.itabs.getTab(window);
        var newid = "123" + new Date().getMilliseconds();
        while (top.itabs.getTab("prosp|" + newid) != null) {
            newid = "123" + new Date().getMilliseconds();
        }
        app.pid = newid;
        top.replaceFrame(thistab.id, "quote|" + newid, "prospect.htm?id=" + newid, "COMPANY", newid, true);
    }

    </script>

</head>
<body style='display:flex;'>
    <div>
    <form id='frmQuote' onsubmit='event.preventDefault()'>
        <table class='form'>
            <tr><th>Prospect #:</th><td><input name='pid' size='6' disabled></td></tr>
            <tr><th>Quote #:</th><td><input name='qid' size='6' disabled></td></tr>
            <tr><th>LOB:</th><td><input size='30' name='lob'></td></tr>
            <tr style='height:1.5em'><td colspan='2'>&nbsp;</td></tr>
            <tr><td colspan='2' style='text-align:center'>
                <button onclick='saveQuote()'>Save Quote</button>
            </td></tr>

        </table>

    </form>
    </div>
</body>
</html>
